#!/usr/bin/env python

import argparse
import logging
import itertools

import h5py
import numpy as np

from sklearn.pipeline import Pipeline
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.cluster import MiniBatchKMeans


def parse_args():
    parser = argparse.ArgumentParser()

    parser.add_argument('--hdf5', required=True)
    parser.add_argument('--log', default='/dev/stderr')
    parser.add_argument('--seed', default=False, type=int)
    parser.add_argument('--dataset', default='sequences')
    parser.add_argument('--sample-size', required=True, type=int)
    parser.add_argument('--n-clusters', required=True, type=int)
    parser.add_argument('--n-samples', type=int, default=1)
    parser.add_argument('--ngram-size', type=int, default=4)

    return parser.parse_args()


def sample_seqs(dset, sample_size):
    index = np.random.random_integers(0, dset.size, sample_size)
    return [ dset[i] for i in index ]


def main():
    args = parse_args()

    logging.basicConfig(level=logging.INFO, filename=args.log)

    logging.info('opening %s' % args.hdf5)

    # setup db

    h5_file = h5py.File(args.hdf5, 'r')

    group = h5_file['/']
    dset = group[args.dataset]

    # setup clustering

    vocabulary = { ''.join(s): i for i, s in enumerate(itertools.product('gatc', repeat=args.ngram_size)) }

    pipeline = Pipeline([('hash', CountVectorizer(analyzer='char',
                                                  ngram_range=(args.ngram_size, args.ngram_size),
                                                  vocabulary=vocabulary)),
                         ('cluster', MiniBatchKMeans(n_clusters=args.n_clusters))])

    for i in range(0, args.n_samples):

        logging.info('sampling')
        sample = sample_seqs(dset, args.sample_size)

        logging.info('fitting')
        pipeline.fit(sample)

        print '%s,%s,%s' % (args.sample_size,
                            args.n_clusters,
                            pipeline.named_steps['cluster'].inertia_)


if __name__ == '__main__':
    main()
